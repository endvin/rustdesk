name: Build Android APK (Simplified)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  RUST_VERSION: "1.75"
  FLUTTER_VERSION: "3.24.5"
  NDK_VERSION: "r26b"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"

jobs:
  build-android-arm64-only:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive
    
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
    
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ env.RUST_VERSION }}
        targets: aarch64-linux-android
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          llvm-dev \
          libclang-dev \
          clang \
          cmake \
          ninja-build \
          pkg-config \
          libgtk-3-dev \
          liblzma-dev \
          nasm
    
    - name: Install cargo-ndk
      run: cargo install cargo-ndk --version 3.1.2
    
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: ${{ env.NDK_VERSION }}
        add-to-path: true
    
    - name: Setup vcpkg
      run: |
        git clone https://github.com/microsoft/vcpkg $HOME/vcpkg
        cd $HOME/vcpkg
        git checkout ${{ env.VCPKG_COMMIT_ID }}
        ./bootstrap-vcpkg.sh
        echo "VCPKG_ROOT=$HOME/vcpkg" >> $GITHUB_ENV
    
    - name: Cache vcpkg
      uses: actions/cache@v3
      with:
        path: $HOME/vcpkg/installed
        key: vcpkg-android-${{ env.VCPKG_COMMIT_ID }}
    
    - name: Install vcpkg dependencies (arm64 only)
      run: |
        $VCPKG_ROOT/vcpkg install --triplet=arm64-android \
          libvpx libyuv opus aom
    
    - name: Install flutter_rust_bridge_codegen
      run: cargo install flutter_rust_bridge_codegen --version 1.80.1
    
    - name: Generate Flutter Rust Bridge
      run: |
        flutter_rust_bridge_codegen \
          --rust-input ./src/flutter_ffi.rs \
          --dart-output ./flutter/lib/generated_bridge.dart \
          --llvm-path /usr/lib/llvm-14
    
    - name: Build Rust library (arm64 only)
      env:
        VCPKG_ROOT: ${{ env.VCPKG_ROOT }}
      run: |
        cargo ndk --platform 21 --target aarch64-linux-android \
          build --release --features flutter
        
        mkdir -p flutter/android/app/src/main/jniLibs/arm64-v8a
        cp target/aarch64-linux-android/release/liblibrustdesk.so \
           flutter/android/app/src/main/jniLibs/arm64-v8a/librustdesk.so
        
        ls -lh flutter/android/app/src/main/jniLibs/arm64-v8a/
    
    - name: Get Flutter dependencies
      working-directory: flutter
      run: flutter pub get
    
    - name: Build APK (arm64 only)
      working-directory: flutter
      run: |
        flutter build apk --release \
          --target-platform android-arm64
    
    - name: Rename APK
      run: |
        cd flutter/build/app/outputs/flutter-apk
        mv app-release.apk rustdesk-arm64-v8a.apk
        ls -lh
    
    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: rustdesk-android-arm64
        path: flutter/build/app/outputs/flutter-apk/rustdesk-arm64-v8a.apk
        retention-days: 30
    
    - name: Build summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "âœ… APK built successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Architecture:** arm64-v8a only" >> $GITHUB_STEP_SUMMARY
        echo "**File:** rustdesk-arm64-v8a.apk" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Download from Artifacts section above." >> $GITHUB_STEP_SUMMARY
